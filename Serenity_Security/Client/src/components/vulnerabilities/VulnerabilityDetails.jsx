import React, { useEffect, useState } from "react";
import { useParams, useNavigate, Link, useLocation } from "react-router-dom";
import { generateRemediationSteps, getVulnerabilityById, toggleRemediationItem } from "../../managers/vulnerabilityManager";
import { Card, CardBody, CardHeader, CardTitle, Button } from "reactstrap";
import { useTheme } from '../theme/ThemeContext';

export const VulnerabilityDetails = () => {
  const { id } = useParams();
  const navigate = useNavigate();
  const location = useLocation();
  const [vulnerability, setVulnerability] = useState(null);
  const [remediationSteps, setRemediationSteps] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [updating, setUpdating] = useState(false);
  const [notification, setNotification] = useState({ show: false, message: "", type: "success" });
  const { colors } = useTheme();

  const getReportId = () => {
    const searchParams = new URLSearchParams(location.search);
    return searchParams.get('reportId');
  };

  useEffect(() => {
    getVulnerabilityById(id)
      .then((data) => {
        setVulnerability(data);
        
        // Check if remediation steps exist
        if (!data.remediationSteps || data.remediationSteps.length === 0) {
          console.log("No remediation steps found, generating...");
          // Auto-generate remediation steps
          generateRemediationSteps(id, true)
            .then((steps) => {
              setRemediationSteps(steps);
              // Update vulnerability object with steps
              setVulnerability({...data, remediationSteps: steps});
              setLoading(false);
            })
            .catch((err) => {
              console.error("Error generating remediation steps:", err);
              setLoading(false);
            });
        } else {
          // Check if remediation steps appear to be generic
          const isGeneric = detectGenericRemediation(data.remediationSteps);
          if (isGeneric) {
            console.log("Detected generic remediation steps, regenerating...");
            generateRemediationSteps(id, true)
              .then((steps) => {
                setRemediationSteps(steps);
                // Update vulnerability object with steps
                setVulnerability({...data, remediationSteps: steps});
                setLoading(false);
              })
              .catch((err) => {
                console.error("Error regenerating steps:", err);
                setRemediationSteps(data.remediationSteps);
                setLoading(false);
              });
          } else {
            setRemediationSteps(data.remediationSteps);
            setLoading(false);
          }
        }
      })
      .catch((err) => {
        setError("Failed to load vulnerability data: " + err.message);
        setLoading(false);
      });
  }, [id]);
  
  // Helper function to detect if remediation steps are generic
  const detectGenericRemediation = (steps) => {
    if (!steps || steps.length === 0) return true;
    
    // Check for signs of generic remediation
    return steps.some(step => 
      (step.description && step.description.includes("Review and apply patches for")) ||
      (!step.verificationSteps) ||
      (step.description && step.description.length < 50) // Very short descriptions are likely generic
    );
  };

  const handleRemediationToggle = (remediationId, isCompleted) => {
    setUpdating(true);
    toggleRemediationItem(remediationId, isCompleted)
      .then((updatedItem) => {
        // Update the local state with the updated remediation item
        setRemediationSteps(steps => 
          steps.map(step => 
            step.id === remediationId ? { ...step, isCompleted } : step
          )
        );
        setUpdating(false);
      })
      .catch((err) => {
        setError("Failed to update remediation status: " + err.message);
        setUpdating(false);
      });
  };
  const handleRegenerateSteps = () => {
    setLoading(true);
    generateRemediationSteps(id, true) // Add the true parameter to force regeneration
      .then((steps) => {
        console.log("Regenerated steps:", steps); // Debug log
        setRemediationSteps(steps);
        // Update the vulnerability object with the new steps
        setVulnerability(prev => ({...prev, remediationSteps: steps}));
        setLoading(false);
        
        // Show notification
        setNotification({
          show: true,
          message: "Remediation steps have been successfully regenerated!",
          type: "success"
        });
        
        // Auto-hide notification after 5 seconds
        setTimeout(() => {
          setNotification(prev => ({ ...prev, show: false }));
        }, 5000);
      })
      .catch((err) => {
        console.error("Error regenerating steps:", err); // Debug log
        setError("Failed to regenerate remediation steps: " + err.message);
        setLoading(false);
        
        // Show error notification
        setNotification({
          show: true,
          message: "Failed to regenerate remediation steps: " + err.message,
          type: "danger"
        });
      });
  };


  // Calculate completion percentage
  const calculateCompletionPercentage = () => {
    if (!remediationSteps || remediationSteps.length === 0) return 0;
    const completedSteps = remediationSteps.filter(step => step.isCompleted).length;
    return Math.round((completedSteps / remediationSteps.length) * 100);
  };

  const getSeverityColor = (severity) => {
    // Convert to lowercase for case-insensitive comparison
    const level = severity?.toLowerCase() || '';
    
    if (level.includes('high') || level.includes('critical'))
      return { bg: '#a83246', text: 'white' }; // Muted red
    
    if (level.includes('medium'))
      return { bg: '#d9b55a', text: '#1b2a3c' }; // Muted yellow with dark text
    
    if (level.includes('low'))
      return { bg: '#5a9178', text: 'white' }; // Muted green
    
    // Default fallback
    return { bg: '#6c757d', text: 'white' }; // Gray for unknown
  };

  const formatDate = (dateString) => {
    if (!dateString) return "Not available";
    const date = new Date(dateString);
    return date.toLocaleDateString();
  };

  if (loading) {
    return <div className="container mt-4">Loading vulnerability data...</div>;
  }

  if (error) {
    return <div className="container mt-4 alert alert-danger">{error}</div>;
  }

  if (!vulnerability) {
    return <div className="container mt-4">Vulnerability not found</div>;
  }

  const completionPercentage = calculateCompletionPercentage();
  const allComplete = completionPercentage === 100;

  return (
    <div className="container mt-4">
      {/* Page Header */}
      <div className="d-flex justify-content-between align-items-center mb-4">
        <h2 style={{ color: colors.colorbg }}>
          Vulnerability Details
        </h2>
        <Button 
          onClick={() => {
            const reportId = getReportId();
            if (reportId) {
              navigate(`/report/${reportId}`);
            } else {
              // If no reportId in URL params, try to use the one from vulnerability data
              const reportIdFromVuln = vulnerability?.reportId;
              if (reportIdFromVuln) {
                navigate(`/report/${reportIdFromVuln}`);
              } else {
                // Last resort: just go back
                navigate(-1);
              }
            }
          }}
          style={{
            backgroundColor: colors.buttonHighlight,
            color: colors.primary,
            border: 'none',
            fontWeight: 'bold'
          }}
        >
          Back to Report
        </Button>
      </div>

      {/* Notification Alert */}
      {notification.show && (
        <div className={`alert alert-${notification.type} mb-4`}>
          {notification.message}
        </div>
      )}

      {/* Vulnerability Details Card */}
      <Card className="mb-4 shadow">
        <CardHeader style={{ 
          backgroundColor: colors.primary,
          color: colors.secondary,
          borderTopLeftRadius: 'inherit',
          borderTopRightRadius: 'inherit',
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'center'
        }}>
          <CardTitle tag="h5" className="mb-0">
            {vulnerability.cveId}
          </CardTitle>
          <div 
            className="severity-badge"
            style={{
              display: 'inline-block',
              padding: '0.25rem 0.75rem',
              borderRadius: '0.25rem',
              fontSize: '0.875rem',
              fontWeight: 'bold',
              backgroundColor: getSeverityColor(vulnerability.severityLevel).bg,
              color: getSeverityColor(vulnerability.severityLevel).text
            }}
          >
            {vulnerability.severityLevel || "Unknown"}
          </div>
        </CardHeader>
        
        <CardBody style={{ 
          backgroundColor: colors.cardBg,
          color: colors.cardText 
        }}>
          <div className="row mb-3">
            <div className="col-md-3">
              <strong>CVSS Score:</strong>
            </div>
            <div className="col-md-9">
              {vulnerability.cvsScore.toFixed(1)}
            </div>
          </div>
          
          <div className="row mb-3">
            <div className="col-md-3">
              <strong>Published:</strong>
            </div>
            <div className="col-md-9">
              {formatDate(vulnerability.publishedAt)}
            </div>
          </div>
          
          <div className="row mb-3">
            <div className="col-md-3">
              <strong>Description:</strong>
            </div>
            <div className="col-md-9">
              {vulnerability.description}
            </div>
          </div>

          {vulnerability.references && (
            <div className="row mb-3">
              <div className="col-md-3">
                <strong>References:</strong>
              </div>
              <div className="col-md-9">
                {vulnerability.references.split("|").map((ref, index) => (
                  <div key={index}>
                    <a 
                      href={ref} 
                      target="_blank" 
                      rel="noopener noreferrer"
                      style={{ color: colors.isDarkMode ? '#90caf9' : '#1976d2' }}
                    >
                      {ref}
                    </a>
                  </div>
                ))}
              </div>
            </div>
          )}
        </CardBody>
      </Card>

      {/* Remediation Checklist Card */}
      <Card className="shadow">
        <CardHeader style={{ 
          backgroundColor: colors.primary,
          color: colors.secondary,
          borderTopLeftRadius: 'inherit',
          borderTopRightRadius: 'inherit',
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'center'
        }}>
          <CardTitle tag="h5" className="mb-0">
            Remediation Checklist
          </CardTitle>
          <div>
            <span 
              style={{
                display: 'inline-block',
                padding: '0.25rem 0.75rem',
                borderRadius: '0.25rem',
                fontSize: '0.875rem',
                fontWeight: 'bold',
                backgroundColor: allComplete ? '#5a9178' : '#d9b55a',
                color: allComplete ? 'white' : '#1b2a3c'
              }}
            >
              {completionPercentage}% Complete
            </span>
          </div>
        </CardHeader>
        
        <CardBody style={{ 
          backgroundColor: colors.cardBg,
          color: colors.cardText 
        }}>
          {remediationSteps.length === 0 ? (
            <div className="alert" style={{
              backgroundColor: colors.isDarkMode ? '#264f78' : '#e3f2fd',
              color: colors.cardText,
              borderColor: colors.isDarkMode ? '#90caf9' : '#1976d2'
            }}>
              No remediation steps available for this vulnerability.
            </div>
          ) : (
            <div>
              <div className="progress mb-4">
                <div 
                  className="progress-bar" 
                  role="progressbar" 
                  style={{ 
                    width: `${completionPercentage}%`,
                    backgroundColor: allComplete ? '#5a9178' : '#d9b55a'
                  }} 
                  aria-valuenow={completionPercentage} 
                  aria-valuemin="0" 
                  aria-valuemax="100"
                >
                  {completionPercentage}%
                </div>
              </div>

              <ul className="list-group">
                {remediationSteps.map((step) => (
                  <li key={step.id} className="list-group-item" style={{
                    backgroundColor: colors.cardBg,
                    color: colors.cardText,
                    borderColor: '#cad8e7'
                  }}>
                    <div className="d-flex align-items-start">
                      <div className="me-3">
                        <div className="form-check">
                          <input
                            className="form-check-input"
                            type="checkbox"
                            id={`step-${step.id}`}
                            checked={step.isCompleted}
                            onChange={(e) => handleRemediationToggle(step.id, e.target.checked)}
                            disabled={updating}
                          />
                        </div>
                      </div>
                      <div className="flex-grow-1">
                        <div className="d-flex justify-content-between">
                          <label 
                            className={`form-check-label ${step.isCompleted ? 'text-decoration-line-through text-muted' : ''}`} 
                            htmlFor={`step-${step.id}`}
                          >
                            <strong>{step.description}</strong>
                          </label>
                          <Link 
                            to={`/remediation/${step.id}?reportId=${getReportId() || vulnerability?.reportId || ''}`} 
                            style={{
                              backgroundColor: colors.primary,
                              color: colors.secondary,
                              padding: '0.25rem 0.5rem',
                              borderRadius: '0.2rem',
                              fontSize: '1.00rem',
                              textDecoration: 'none',
                              display: 'inline-block'
                            }}
                          >
                            Details
                          </Link>
                        </div>
                        {step.verificationSteps && (
                          <div className="mt-2" style={{ color: colors.isDarkMode ? '#9ca3af' : '#4b5563' }}>
                            <small><strong>Verification:</strong> {step.verificationSteps}</small>
                          </div>
                        )}
                        {step.fixedVersion && (
                          <div className="mt-1" style={{ color: colors.isDarkMode ? '#9ca3af' : '#4b5563' }}>
                            <small><strong>Fixed in version:</strong> {step.fixedVersion}</small>
                          </div>
                        )}
                      </div>
                    </div>
                  </li>
                ))}
              </ul>
              
              {allComplete && (
                <div className="alert mt-3" style={{
                  backgroundColor: colors.isDarkMode ? '#0f3d30' : '#d1e7dd',
                  color: colors.isDarkMode ? '#5a9178' : '#0f5132',
                  borderColor: colors.isDarkMode ? '#5a9178' : '#badbcc'
                }}>
                  <i className="bi bi-check-circle-fill me-2"></i>
                  All remediation steps completed!
                </div>
              )}
            </div>
          )}
        </CardBody>
      </Card>
    </div>
  );
};